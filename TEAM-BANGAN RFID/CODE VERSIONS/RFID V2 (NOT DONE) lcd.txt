#include <SPI.h>
#include <MFRC522.h>

#define SS_PIN 10
#define RST_PIN 9

MFRC522 mfrc522(SS_PIN, RST_PIN);

byte card_ID[4];
byte Name1[4] = {0x46, 0x70, 0xDE, 0x00};
byte Name2[4] = {0xF9, 0x09, 0x04, 0x01};
byte Name3[4] = {0xD4, 0x87, 0x1D, 0x2A}; // New Student 3
byte Name4[4] = {0x39, 0x39, 0xE5, 0xB9}; // New Student 4

int NumbCard[4] = {0, 0, 0, 0}; // Updated for 4 cards
int j = -1;

int const RedLed = 6;
int const GreenLed = 5;
int const Buzzer = 8;

String Name;
String UID;
String GradeSection;
String ContactNumber;
String TimeIn[4] = {"", "", "", ""};
String TimeOut[4] = {"", "", "", ""};

void setup() {
    Serial.begin(9600);
    SPI.begin();
    mfrc522.PCD_Init();

    Serial.println("CLEARSHEET");
    Serial.println("LABEL,Date,Time,Name,UID,Grade & Section,Contact Number,Time In,Time Out");

    pinMode(RedLed, OUTPUT);
    pinMode(GreenLed, OUTPUT);
    pinMode(Buzzer, OUTPUT);
}

void loop() {
    if (!mfrc522.PICC_IsNewCardPresent()) {
        return;
    }
    if (!mfrc522.PICC_ReadCardSerial()) {
        return;
    }

    UID = "";
    for (byte i = 0; i < mfrc522.uid.size; i++) {
        card_ID[i] = mfrc522.uid.uidByte[i];
        UID += String(card_ID[i], HEX);
    }

    if (memcmp(card_ID, Name1, 4) == 0) {
        Name = "Ean Gingoyon";
        UID = "12345678";
        GradeSection = "Grade 10 - Happiness";
        ContactNumber = "9876543210";
        j = 0;
    } else if (memcmp(card_ID, Name2, 4) == 0) {
        Name = "Jane Smith";
        UID = "87654321";
        GradeSection = "Grade 12 - B";
        ContactNumber = "9123456789";
        j = 1;
    } else if (memcmp(card_ID, Name3, 4) == 0) {
        Name = "Lybrone Neri";
        UID = "11223344";
        GradeSection = "Grade 11 - A";
        ContactNumber = "9000000001";
        j = 2;
    } else if (memcmp(card_ID, Name4, 4) == 0) {
        Name = "Rean Alvarez";
        UID = "99887766";
        GradeSection = "Grade 9 - C";
        ContactNumber = "9000000002";
        j = 3;
    } else {
        digitalWrite(GreenLed, LOW);
        digitalWrite(RedLed, HIGH);
        for (int i = 0; i < 3; i++) {
            digitalWrite(Buzzer, HIGH);
            delay(200);
            digitalWrite(Buzzer, LOW);
            delay(200);
        }
        delay(500);
        digitalWrite(RedLed, LOW);
        return;
    }

    String currentTime = "TIME"; // Replace with real time later

    if (NumbCard[j] == 0) {
        TimeIn[j] = currentTime;
        TimeOut[j] = "";
        NumbCard[j] = 1;

        Serial.print("DATA,DATE," + currentTime + "," + Name + "," + UID + "," + GradeSection + "," + ContactNumber + "," + TimeIn[j] + ",");
        Serial.println();
        Serial.println("SAVEWORKBOOKAS,Attendance/AttendanceList");
    } else if (NumbCard[j] == 1) {
        TimeOut[j] = currentTime;

        Serial.print("DATA,DATE," + currentTime + "," + Name + "," + UID + "," + GradeSection + "," + ContactNumber + ",," + TimeOut[j]);
        Serial.println();

        NumbCard[j] = 0;
    }

    digitalWrite(GreenLed, HIGH);
    digitalWrite(RedLed, LOW);
    for (int i = 0; i < 2; i++) {
        digitalWrite(Buzzer, HIGH);
        delay(100);
        digitalWrite(Buzzer, LOW);
        delay(100);
    }
    delay(500);
    digitalWrite(GreenLed, LOW);
    digitalWrite(RedLed, LOW);
}
